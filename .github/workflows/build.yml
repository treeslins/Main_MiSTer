name: build-mister

on:
  push:
    branches: [ master, cjk-osd ]   # 只要 master 就改成 [ master ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1) 启用 armhf 架构并重写 sources.list：
      #    - amd64 用 archive/security（加 [arch=amd64]）
      #    - armhf 全部走 ports.ubuntu.com（加 [arch=armhf]）
      - name: Configure APT sources for multiarch
        run: |
          set -e
          sudo dpkg --add-architecture armhf
          sudo bash -c 'cat > /etc/apt/sources.list << "EOF"
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy main universe multiverse restricted
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-updates main universe multiverse restricted
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu jammy-backports main universe multiverse restricted
          deb [arch=amd64] http://security.ubuntu.com/ubuntu jammy-security main universe multiverse restricted
          deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports jammy main universe multiverse restricted
          deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports jammy-updates main universe multiverse restricted
          deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports jammy-backports main universe multiverse restricted
          deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports jammy-security main universe multiverse restricted
          EOF'
          sudo apt-get update

      # 2) 安装交叉编译器与 FreeType（armhf）
      - name: Install toolchains and deps
        run: |
          set -e
          sudo apt-get install -y \
            make pkg-config zip \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            libfreetype6-dev:armhf zlib1g-dev:armhf libpng-dev:armhf libbz2-dev:armhf

      # 3) 兼容别名：如 Makefile 写死 arm-none-linux-gnueabihf-*，映射到系统已有工具
      - name: Add arm-none aliases (compat)
        run: |
          set -e
          for x in gcc g++ ar as ld strip objcopy objdump ranlib nm; do
            src="$(command -v arm-linux-gnueabihf-$x)"
            [ -n "$src" ] || { echo "missing arm-linux-gnueabihf-$x"; exit 1; }
            sudo ln -sf "$src" /usr/bin/arm-none-linux-gnueabihf-$x
          done

      # 4) 编译：通过 pkg-config 拿到 freetype2 的头文件与库
      - name: Build
        env:
          PKG_CONFIG_LIBDIR: /usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/share/pkgconfig
        run: |
          set -e
          make clean || true
          FT_CFLAGS="$(pkg-config --cflags freetype2)"
          FT_LIBS="$(pkg-config --libs freetype2)"
          echo "freetype2 cflags: ${FT_CFLAGS}"
          echo "freetype2 libs:   ${FT_LIBS}"
          make -j"$(nproc)" \
            CROSS_COMPILE=arm-linux-gnueabihf- \
            CFLAGS="$CFLAGS $FT_CFLAGS" \
            CXXFLAGS="$CXXFLAGS $FT_CFLAGS" \
            CPPFLAGS="$CPPFLAGS $FT_CFLAGS" \
            LIBS="$LIBS $FT_LIBS" \
            LDLIBS="$LDLIBS $FT_LIBS"

      - name: Show result
        run: |
          file ./MiSTer || true
          ls -lh ./MiSTer || (echo "Build did not produce MiSTer binary" && exit 1)

      - name: Zip artifact
        run: zip -9 MiSTer-${{ github.ref_name }}-${{ github.sha }}.zip MiSTer

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: MiSTer-${{ github.ref_name }}
          path: |
            MiSTer
            MiSTer-*.zip
          retention-days: 14
